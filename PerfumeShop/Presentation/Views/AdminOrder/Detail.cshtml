@using PerfumeShop.Application.DTOs
@model AdminOrderDetailVM
@{
    Layout = "_AdminLayout";
}

<style>
    .order-info-box {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        margin-bottom: 25px;
    }
</style>

<h2 class="mb-3">Chi tiết đơn <span class="text-primary">@Model.OrderCode</span></h2>

<div class="order-info-box">

    <p><b>Khách hàng:</b> @Model.CustomerName</p>
    <p><b>SĐT:</b> @Model.Phone</p>
    <p><b>Địa chỉ:</b> @Model.Address</p>

    <h4 class="mt-3">
        <b>Trạng thái:</b> <span class="badge bg-info">@Model.Status</span>
    </h4>

    <!-- Select + Button -->
    <div class="mt-3">
        <select id="orderStatus" class="form-select w-25 d-inline-block">
            <option value="Pending" @@(Model.Status=="Pending"?"selected":"" )>Pending</option>
            <option value="Shipping" @@(Model.Status=="Shipping"?"selected":"" )>Shipping</option>
            <option value="Completed" @@(Model.Status=="Completed"?"selected":"" )>Completed</option>
            <option value="Cancelled" @@(Model.Status=="Cancelled"?"selected":"" )>Cancelled</option>
        </select>

        <button class="btn btn-dark ms-2" onclick="updateStatus(@Model.Id)">
            Cập nhật
        </button>
    </div>
</div>

<h3>Sản phẩm trong đơn</h3>
<table class="table table-bordered bg-white shadow-sm">
    <tr>
        <th>Ảnh</th>
        <th>Sản phẩm</th>
        <th>Giá</th>
        <th>Số lượng</th>
    </tr>

    @foreach (var item in Model.Items)
    {
        <tr>    
            
            <td><img src="@item.Image" width="50" class="rounded" /></td>
            <td>@item.ProductName</td>
            <td>@item.Price.ToString("N0") đ</td>
            <td>@item.Quantity</td>
        </tr>
    }
</table>

<h3 class="text-end mt-3">Tổng: <span class="text-danger fw-bold">@Model.TotalAmount.ToString("N0") đ</span></h3>


@section Scripts {

<script>

// ===============================
// UPDATE ORDER STATUS (AJAX)
// ===============================
function updateStatus(orderId) {

    const status = document.getElementById("orderStatus").value;

    fetch(`/AdminOrder/UpdateStatus/${orderId}`, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `status=${status}`
    })
    .then(res => {
        if (!res.ok) throw new Error("Lỗi server");
        return res.text(); 
    })
    .then(() => {
        Swal.fire({
            icon: "success",
            title: "Cập nhật thành công!",
            text: "Trạng thái đơn hàng đã được thay đổi.",
            timer: 1500,
            showConfirmButton: false
        });

        setTimeout(() => location.reload(), 1500);
    })
    .catch(() => {
        Swal.fire({
            icon: "error",
            title: "Lỗi!",
            text: "Không thể cập nhật trạng thái.",
        });
    });

}

</script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

}
