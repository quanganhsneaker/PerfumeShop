@using PerfumeShop.Domain.Models
@model Product
@{
    Layout = "_ShopLayout";
}

@if (Model == null)
{
    <h3 class="text-danger">Không tìm thấy sản phẩm.</h3>
    <a class="btn btn-primary" href="/Shop">Quay lại</a>
    return;
}
<style>

    /* =============================
       COMMON FADE-IN
    ============================= */
    .fade-in {
        animation: fadeIn 0.6s ease-out;
    }
    @@keyframes fadeIn {
        from

    {
        opacity: 0;
        transform: translateY(15px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    /* =============================
       BANNER FLASH SALE
    ============================= */
    .flash-sale-banner {
        padding: 12px 18px;
        background: linear-gradient(135deg, #ff4d4d, #ff9500);
        border-radius: 12px;
        color: #fff;
        font-size: 18px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0px 4px 15px rgba(255, 90, 0, 0.4);
        animation: fadeIn 0.8s ease;
    }

    /* Thời gian flash sale */
    .flash-timer {
        font-size: 16px;
        background: #fff;
        color: #d10000;
        padding: 3px 10px;
        border-radius: 6px;
        font-weight: 700;
    }

    /* =============================
       BUY NOW BUTTON — VIBRATE
    ============================= */
    .btn-buy-now {
        padding: 12px 28px;
        font-size: 18px;
        font-weight: 700;
        background: linear-gradient(135deg, #ff64b4, #b06bff);
        color: #fff;
        border-radius: 12px;
        border: none;
        margin-left: 14px;
        animation: pulse 1.5s infinite;
        cursor: pointer;
    }
    @@keyframes pulse {
        0%

    {
        transform: scale(1);
    }

    50% {
        transform: scale(1.06);
    }

    100% {
        transform: scale(1);
    }

    }

    /* =============================
       PRODUCT IMAGE CAROUSEL
    ============================= */
    .carousel-thumbs img {
        width: 80px;
        height: 80px;
        border-radius: 10px;
        object-fit: cover;
        margin-right: 10px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: 0.2s;
    }

        .carousel-thumbs img:hover {
            border-color: #ff64b4;
        }

    /* =============================
       RATING SUMMARY
    ============================= */
    .rating-summary-box {
        background: #fff;
        border-radius: 12px;
        padding: 22px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        margin-top: 40px;
    }

    .rating-summary-number {
        font-size: 42px;
        font-weight: 900;
        color: #ff9500;
    }

    .rating-summary-stars {
        font-size: 22px;
        color: #ffb400;
    }

    /* thanh rating từng sao */
    .rating-row {
        display: flex;
        align-items: center;
        margin-bottom: 6px;
    }

    .rating-bar {
        height: 8px;
        background: #eee;
        border-radius: 8px;
        margin: 0 10px;
        flex-grow: 1;
        overflow: hidden;
    }

    .rating-bar-fill {
        height: 100%;
        background: #ffb400;
    }

    /* =============================
       SWEETALERT2 POPUP REVIEW
    ============================= */
    .swal-review-popup {
        border-radius: 20px !important;
        padding: 25px !important;
    }

    .swal-rating-star {
        font-size: 28px;
        cursor: pointer;
        color: #ddd;
        transition: .2s;
    }

        .swal-rating-star.selected,
        .swal-rating-star:hover {
            color: #ffca28 !important;
            transform: scale(1.15);
        }

</style>

<div class="fade-in">

    <!-- FLASH SALE -->
    <div class="flash-sale-banner mb-3">
        🔥 FLASH SALE
        <span class="flash-timer" id="flashTimer">01:59:59</span>
    </div>

    <h2 class="product-title">@Model.Name</h2>

    <div class="row mt-4">

        <!-- Ảnh + Carousel -->
        <div class="col-md-6 fade-in">

            <img id="mainImage" src="@Model.ImageUrl" class="img-fluid rounded shadow" />

            <div class="carousel-thumbs d-flex mt-3">
                <img src="@Model.ImageUrl" onclick="changeImage(this.src)">
                <img src="@Model.ImageUrl" onclick="changeImage(this.src)">
                <img src="@Model.ImageUrl" onclick="changeImage(this.src)">
            </div>
        </div>

        <!-- Thông tin -->
        <div class="col-md-6 fade-in" style="animation-delay:.1s">

            <div class="product-price">@Model.Price.ToString("N0") đ</div>

            <p class="mt-2"><strong>Danh mục:</strong> @Model.Category?.Name</p>
            <p>
                @Html.Raw(Model.Description.Replace("\n", "<br>"))
            </p>


            <button class="btn-add-cart mt-3"
                    onclick="addToCart('@Model.ImageUrl', @Model.Id)">
                🛒 Thêm vào giỏ
            </button>

            <button class="btn-buy-now"
                    onclick="buyNow(@Model.Id)">
                Mua ngay
            </button>
        </div>
    </div>

    <!-- TỔNG QUAN ĐÁNH GIÁ -->
    <div class="rating-summary-box fade-in">
        <h4>⭐ Tổng quan đánh giá</h4>

        <div class="d-flex align-items-center">
            <div class="rating-summary-number">
                @((Model.Reviews.Any()? Model.Reviews.Average(r => r.Rating) : 0 ).ToString("0.0"))
            </div>
            <div class="ms-3 rating-summary-stars">
                ★★★★★
            </div>
        </div>

        @for (int i = 5; i >= 1; i--)
        {
            var count = Model.Reviews.Count(r => r.Rating == i);
            var percent = (Model.Reviews.Count() > 0)
            ? (count * 100 / Model.Reviews.Count())
            : 0;

            <div class="rating-row">
                <span>@i ★</span>
                <div class="rating-bar">
                    <div class="rating-bar-fill" style="width:@percent%"></div>
                </div>
                <span>@count</span>
            </div>
        }
    </div>

    <!-- DANH SÁCH REVIEW -->
    <div class="review-section fade-in">

        <div class="d-flex justify-content-between mt-4">
            <h4>💬 Đánh giá sản phẩm</h4>
           
        </div>

        @if (!Model.Reviews.Any())
        {
            <p class="text-muted">Chưa có đánh giá nào.</p>
        }
        else
        {
            foreach (var r in Model.Reviews.OrderByDescending(x => x.CreatedAt))
            {
                <div class="review-card fade-in">

                    <div class="review-header">
                        <img class="review-avatar" src="https://i.pravatar.cc/100?u=@r.UserId" />
                        <div>
                            <div class="review-name">@r.User.FullName</div>
                            <div class="stars">
                                @for (int i = 1; i <= r.Rating; i++)
                                {
                                    <span>★</span>
                                }
                                @for (int i = r.Rating + 1; i <= 5; i++)
                                {
                                    <span style="color:#ddd">★</span>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="review-comment">@r.Comment</div>

                    <small class="review-date">@r.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                </div>
            }
        }
    </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // =====================
    // CAROUSEL IMAGE CHANGE
    // =====================
    function changeImage(src) {
        document.getElementById("mainImage").src = src;
    }

    // =====================
    // FLASH SALE TIMER
    // =====================
    let time = 7200; // 2h
    setInterval(() => {
        let h = String(Math.floor(time/3600)).padStart(2,'0');
        let m = String(Math.floor((time%3600)/60)).padStart(2,'0');
        let s = String(time%60).padStart(2,'0');
        document.getElementById("flashTimer").innerText = `${h}:${m}:${s}`;
        time--;
    }, 1000);

    // =====================
    // BUY NOW VIBRATION
    // =====================
    function buyNow() {
        window.location.href = "/Cart/Add/@Model.Id";
    }

    // =====================
    // REVIEW SWEETALERT POPUP
    // =====================
    function openReviewPopup() {
        Swal.fire({
            title: "Đánh giá sản phẩm",
            html: `
                <div id="ratingStars">
                    <span class="swal-rating-star" data-val="1">★</span>
                    <span class="swal-rating-star" data-val="2">★</span>
                    <span class="swal-rating-star" data-val="3">★</span>
                    <span class="swal-rating-star" data-val="4">★</span>
                    <span class="swal-rating-star" data-val="5">★</span>
                </div>
                <textarea id="reviewComment" class="form-control mt-3" rows="3"
                 placeholder="Nhận xét của bạn..."></textarea>
            `,
            confirmButtonText: "Gửi đánh giá",
            customClass: {
                popup: "swal-review-popup"
            },
            preConfirm: () => {
                let rating = document.querySelector(".swal-rating-star.selected")?.dataset.val;
                let comment = document.getElementById("reviewComment").value;
                if (!rating) return Swal.showValidationMessage("Hãy chọn số sao!");
                return { rating, comment };
            }
        }).then(result => {
            if (result.isConfirmed) {
                // Gửi form bằng POST
                fetch("/Review/AddReview", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        ProductId: @Model.Id,
                        Rating: result.value.rating,
                        Comment: result.value.comment
                    })
                }).then(() => Swal.fire("Đã gửi!", "Cảm ơn đánh giá của bạn ❤️", "success"));
            }
        });

        // Sự kiện chọn sao
        document.querySelectorAll(".swal-rating-star").forEach(star => {
            star.addEventListener("click", () => {
                document.querySelectorAll(".swal-rating-star")
                    .forEach(s => s.classList.remove("selected"));
                star.classList.add("selected");
            });
        });
    }
</script>

