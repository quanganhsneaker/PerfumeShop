@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Admin Dashboard";
}

<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

<div class="container mt-4">

    <h2 class="fw-bold mb-4">📊 Admin Dashboard</h2>

    <div class="row g-4">

        <!-- Tổng doanh thu -->
        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h6 class="text-secondary">Tổng doanh thu</h6>
                    <h3 class="fw-bold text-success">@ViewBag.TotalRevenue.ToString("N0") đ</h3>
                </div>
            </div>
        </div>

        <!-- Tổng đơn hàng -->
        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h6 class="text-secondary">Tổng đơn hàng</h6>
                    <h3 class="fw-bold">@ViewBag.TotalOrders</h3>
                </div>
            </div>
        </div>

        <!-- Tổng Users -->
        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h6 class="text-secondary">Tổng người dùng</h6>
                    <h3 class="fw-bold">@ViewBag.TotalUsers</h3>
                </div>
            </div>
        </div>

    </div>


    <!-- Biểu đồ doanh thu theo tháng -->
    <div class="card mt-5 shadow-sm border-0">
        <div class="card-body">
            <h5 class="fw-bold mb-3">📈 Doanh thu theo tháng</h5>
            <canvas id="revenueChart" height="120"></canvas>
        </div>
    </div>


</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    function loadRevenueChart() {

        // Tự tính 30 ngày gần nhất
        let end = new Date().toISOString().split("T")[0];
        let start = new Date(Date.now() - 29 * 24 * 3600 * 1000)
                        .toISOString().split("T")[0];

        fetch(`/AdminStatics/RevenueDaily?start=${start}&end=${end}`)
            .then(res => res.json())
            .then(data => {

                const ctx = document.getElementById("revenueChart");

                const chart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: data.map(x => x.date),
                        datasets: [{
                            label: "Doanh thu",
                            data: data.map(x => x.total),
                            borderColor: "#3b82f6",
                            backgroundColor: "rgba(59,130,246,0.35)",
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: ctx =>
                                        ctx.raw.toLocaleString("vi-VN") + " đ"
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: v => v.toLocaleString("vi-VN")
                                }
                            }
                        }
                    }
                });

            });
    }

    // Gọi khi trang load
    loadRevenueChart();
</script>
