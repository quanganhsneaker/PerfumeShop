@using PerfumeShop.Application.DTOs
@using PerfumeShop.Infrastructure.Data
@model OrderDetailVM
@inject ApplicationDbContext _db
@{
    Layout = "_ShopLayout";
}
<style>
    /* Fade in toàn trang */
    .fade-in {
        animation: fadeIn 0.6s ease-in-out;
    }

    @@keyframes fadeIn {
        from

    {
        opacity: 0;
        transform: translateY(15px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    /* Card sản phẩm */
    .review-card {
        border-radius: 14px;
        padding: 18px;
        background: #fff;
        box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        transition: 0.3s;
    }

        .review-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

    /* Tiêu đề và trạng thái */
    .order-title {
        font-size: 26px;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .status-pill {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
    }

    .status-completed {
        background: #d1f7d1;
        color: #0a820a;
    }

    .status-pending {
        background: #ffe9b3;
        color: #b88000;
    }

    /* Ảnh sản phẩm */
    .item-img {
        width: 60px;
        height: 60px;
        border-radius: 10px;
        object-fit: cover;
    }

    /* Đánh giá sao */
    .star-rating {
        display: flex;
        font-size: 26px;
        cursor: pointer;
        margin-bottom: 10px;
    }

    .star {
        color: #ccc;
        transition: 0.2s;
    }

        .star:hover,
        .star.selected {
            color: #ffb700;
            transform: scale(1.1);
        }

    /* Textarea */
    .review-textarea {
        border-radius: 10px;
        padding: 12px;
    }

    /* Nút gửi gradient */
    .btn-review {
        border: none;
        background: linear-gradient(135deg, #ff64b4, #b06bff);
        color: white;
        border-radius: 10px;
        padding: 10px 22px;
        font-weight: 600;
        transition: 0.25s;
    }

        .btn-review:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(176,107,255,0.5);
        }
</style>
<div class="fade-in">

    <h2 class="order-title">Đơn hàng @Model.OrderCode</h2>

    <p>
        <b>Trạng thái: </b>
        <span class="status-pill
              @(Model.Status == "Completed" ? "status-completed" : "status-pending")">
            @Model.Status
        </span>
    </p>

    <p><b>Ngày đặt:</b> @Model.CreatedAt</p>

    <table class="table table-bordered bg-white fade-in">
        <tr class="table-dark">
            <th>Ảnh</th>
            <th>Sản phẩm</th>
            <th>Giá</th>
            <th>Số lượng</th>
        </tr>

        @foreach (var item in Model.Items)
        {
            <tr>
                <td><img src="@item.Image" class="item-img" /></td>
                <td>@item.ProductName</td>
                <td>@item.Price.ToString("N0") đ</td>
                <td>@item.Quantity</td>
            </tr>
        }
    </table>

    @if (Model.Status == "Completed")
    {
        <h4 class="mt-4">Đánh giá sản phẩm</h4>

        @foreach (var item in Model.Items)
        {
            <div class="review-card mb-3 fade-in">

                <h5>@item.ProductName</h5>

                @{
                    bool reviewed = _db.Reviews.Any(r =>
                    r.UserId == Model.UserId &&
                    r.ProductId == item.ProductId);
                }

                @if (!reviewed)
                {
                    <!-- FORM REVIEW -->
                    <form method="post" action="/Review/AddReview">

                        <input type="hidden" name="ProductId" value="@item.ProductId" />
                        <input type="hidden" name="OrderId" value="@Model.Id" />

                        <!-- Sao -->
                        <div class="star-rating" data-target="@item.ProductId">
                            <span class="star" data-value="1">★</span>
                            <span class="star" data-value="2">★</span>
                            <span class="star" data-value="3">★</span>
                            <span class="star" data-value="4">★</span>
                            <span class="star" data-value="5">★</span>
                        </div>

                        <input type="hidden" name="Rating" id="rating-@item.ProductId" required />

                        <textarea class="form-control review-textarea mb-2"
                      name="Comment"
                      placeholder="Chia sẻ cảm nhận sản phẩm..."
                      rows="3"></textarea>

                        <button class="btn-review">Gửi đánh giá</button>
                    </form>
                }
                else
                {
                    <p class="text-success fw-bold mt-2">✔ Bạn đã đánh giá sản phẩm này.</p>
                }
            </div>
        }
    }
    else
    {
        <p class="text-muted">Đơn hàng chưa hoàn thành – không thể đánh giá.</p>
    }

</div>

<script>
    // Hiệu ứng chọn sao
    document.querySelectorAll('.star-rating').forEach(group => {
        const stars = group.querySelectorAll('.star');
        const productId = group.getAttribute("data-target");
        const ratingInput = document.getElementById("rating-" + productId);

        stars.forEach(star => {
            star.addEventListener("mouseover", () => {
                stars.forEach(s => s.classList.remove("selected"));
                let val = star.dataset.value;

                for (let i = 0; i < val; i++)
                    stars[i].classList.add("selected");
            });

            star.addEventListener("click", () => {
                ratingInput.value = star.dataset.value;
            });

            group.addEventListener("mouseleave", () => {
                stars.forEach(s => s.classList.remove("selected"));
            });
        });
    });
</script>
